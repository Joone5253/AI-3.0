<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Code Engine - AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            bg: '#f0f4f9',
                            darkBg: '#131314',
                            sidebar: '#e9eef6',
                            darkSidebar: '#1e1f20',
                            userBubble: '#e3e3e3',
                            darkUserBubble: '#282a2c'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-down': 'slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>

    <style>
        /* Base Resets & Layout */
        body { margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbars for a premium feel */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(75, 85, 99, 0.5); }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }

        /* Loader Animation */
        .loader-dots div { animation-timing-function: cubic-bezier(0, 1, 1, 0); }
        .loader-dots div:nth-child(1) { left: 8px; animation: loader-dots1 0.6s infinite; }
        .loader-dots div:nth-child(2) { left: 8px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(3) { left: 32px; animation: loader-dots2 0.6s infinite; }
        .loader-dots div:nth-child(4) { left: 56px; animation: loader-dots3 0.6s infinite; }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes loader-dots3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
        @keyframes loader-dots2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }

        /* Markdown Styling - Highly Polished */
        .markdown-body p { margin-bottom: 0.75em; line-height: 1.6; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .markdown-body pre { background: #1f2937; color: #f8f8f2; padding: 1rem; border-radius: 0.75rem; overflow-x: auto; margin-top: 0.5em; margin-bottom: 1em; font-size: 0.875rem; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .markdown-body code { font-family: monospace; background: rgba(128,128,128,0.15); padding: 0.2em 0.4em; border-radius: 0.25rem; font-size: 0.9em; }
        .markdown-body pre code { background: transparent; padding: 0; font-size: 0.875rem; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body blockquote { border-left: 4px solid #3b82f6; padding-left: 1em; color: #4b5563; font-style: italic; margin-bottom: 1em; background: rgba(59, 130, 246, 0.05); padding-top: 0.5em; padding-bottom: 0.5em; border-radius: 0 0.5rem 0.5rem 0; }
        .dark .markdown-body blockquote { border-left-color: #3b82f6; color: #9ca3af; background: rgba(59, 130, 246, 0.1); }
        .markdown-body a { color: #3b82f6; text-decoration: underline; text-underline-offset: 2px; }

        /* Blinking Cursor for Typing Effect */
        .typing-cursor::after { content: 'â–‹'; display: inline-block; animation: blink 1s step-end infinite; margin-left: 2px; color: #3b82f6; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* Utility for hiding scrollbar completely but allowing scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-white dark:bg-gemini-darkBg text-gray-800 dark:text-gray-100 min-h-[100dvh] flex flex-col font-sans transition-colors duration-200">

    <div id="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white dark:bg-gemini-darkBg z-[100]">
        <div class="loader-dots relative w-20 h-5 mb-6">
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-500"></div>
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-500"></div>
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-500"></div>
            <div class="absolute top-0 w-3 h-3 rounded-full bg-blue-500"></div>
        </div>
        
        <div class="flex flex-col items-center mt-2 text-center">
            <p class="text-gray-600 dark:text-gray-300 font-medium animate-pulse text-lg tracking-wide">
                Calibrating neural links...
            </p>
            <div class="h-1 w-12 bg-blue-500 rounded-full my-4 opacity-50"></div>
            <p class="text-gray-400 dark:text-gray-500 text-xs sm:text-sm font-mono tracking-[0.2em] uppercase font-bold">
                Studio Code Engine
            </p>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[110] flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4"></div>

    <div id="app" class="hidden flex-1 flex min-h-[100dvh] w-full overflow-hidden relative">
        
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden transition-opacity backdrop-blur-sm" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 z-50 w-72 bg-gemini-sidebar dark:bg-gemini-darkSidebar transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col h-full border-r border-gray-200 dark:border-gray-800/50 shadow-xl md:shadow-none">
            
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex-1 flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 px-4 py-3 rounded-xl text-sm font-semibold shadow-sm transition-all duration-200 border border-gray-200 dark:border-gray-700 hover:shadow-md">
                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                    <span>New Chat</span>
                </button>
                <button onclick="toggleSidebar()" class="md:hidden ml-3 p-2 text-gray-500 hover:text-gray-800 dark:hover:text-white bg-gray-200/50 dark:bg-gray-800/50 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-3 py-2 custom-scrollbar">
                <p class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-3 px-2">Recent Conversations</p>
                <div id="chat-list" class="space-y-1">
                    </div>
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800/50 bg-gemini-sidebar dark:bg-gemini-darkSidebar">
                <button onclick="openSettings()" class="w-full flex items-center justify-center gap-3 px-3 py-3 rounded-xl hover:bg-gray-200/80 dark:hover:bg-gray-800 text-sm font-semibold text-gray-700 dark:text-gray-300 transition-colors border border-transparent hover:border-gray-300 dark:hover:border-gray-700">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Engine Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-gemini-darkBg relative">
            
            <header class="flex items-center justify-between p-3 md:p-4 shrink-0 bg-white/80 dark:bg-gemini-darkBg/80 backdrop-blur-md sticky top-0 z-30 border-b border-transparent">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 -ml-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 id="current-chat-title" class="text-lg font-bold truncate max-w-[200px] md:max-w-md text-gray-800 dark:text-gray-100">New Interface</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleTheme()" class="p-2.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700" title="Toggle Theme">
                        <svg id="theme-icon-moon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <svg id="theme-icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto px-4 md:px-8 pb-32 flex flex-col gap-8 scroll-smooth pt-4">
                
                <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center max-w-2xl mx-auto w-full mt-10 md:mt-20 animate-fade-in">
                    <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/40 dark:to-purple-900/40 flex items-center justify-center mb-8 shadow-inner border border-white dark:border-gray-800">
                        <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h2 class="text-4xl md:text-5xl font-extrabold mb-4 tracking-tight text-gray-900 dark:text-white">Studio Code <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">Engine</span></h2>
                    <p class="text-gray-500 dark:text-gray-400 text-lg md:text-xl max-w-lg font-medium">Your universal AI interface. Calibrated and ready to assist.</p>
                </div>
                
                </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 md:px-8 bg-gradient-to-t from-white via-white to-transparent dark:from-gemini-darkBg dark:via-gemini-darkBg dark:to-transparent pt-10">
                <div class="max-w-4xl mx-auto relative">
                    <div class="relative flex items-end gap-2 bg-gemini-bg dark:bg-gemini-darkSidebar rounded-[2rem] p-2 pl-6 border border-gray-200 dark:border-gray-700 focus-within:border-blue-400 dark:focus-within:border-blue-500 shadow-lg focus-within:shadow-xl transition-all duration-300">
                        
                        <textarea id="message-input" rows="1" class="flex-1 bg-transparent border-none outline-none resize-none max-h-48 py-3 text-[16px] text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 no-scrollbar" placeholder="Enter a command or prompt..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                        
                        <div class="flex items-center gap-1 shrink-0 pb-1 pr-1">
                            <button id="send-btn" onclick="sendMessage()" class="p-3 rounded-full bg-blue-600 hover:bg-blue-700 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center w-12 h-12 shadow-md hover:shadow-lg transform active:scale-95">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="text-center mt-3 pb-2">
                        <p class="text-[12px] font-medium text-gray-400 dark:text-gray-500 tracking-wide">Studio Engine may produce inaccurate information. Verify critical outputs.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border border-gray-200 dark:border-gray-700 animate-slide-down">
            <div class="px-6 py-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/80">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">Engine Configuration</h3>
                </div>
                <button onclick="closeSettings()" class="p-2 text-gray-400 hover:text-gray-800 dark:hover:text-white bg-gray-200/50 dark:bg-gray-800 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">OpenRouter API Key <span class="text-red-500">*</span></label>
                    <input type="password" id="api-key-input" class="w-full px-4 py-3 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all dark:text-white shadow-sm" placeholder="sk-or-v1-...">
                    <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Required to communicate with the AI models.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Model Endpoint</label>
                    <input type="text" id="model-input" class="w-full px-4 py-3 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all dark:text-white shadow-sm font-mono text-sm" placeholder="deepseek/deepseek-r1:free" value="deepseek/deepseek-r1:free">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Core Directive (System Prompt)</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full px-4 py-3 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all resize-none dark:text-white shadow-sm" placeholder="You are Studio Code Engine, an elite AI assistant..."></textarea>
                </div>
            </div>

            <div class="px-6 py-5 border-t border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/80 flex justify-end gap-3">
                <button onclick="closeSettings()" class="px-5 py-2.5 text-sm font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2.5 text-sm font-bold bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Save Configuration
                </button>
            </div>
        </div>
    </div>


    <script>
        /** * STUDIO CODE ENGINE - Vanilla JS Core
         * Architecture: State -> Render -> API Stream -> State Update
         */

        // --- CONSTANTS & INITIAL STATE ---
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        const STORAGE_KEY = 'studioCodeEngineState_v1';
        
        let state = {
            apiKey: "",
            model: DEFAULT_MODEL,
            systemPrompt: "",
            darkMode: false,
            chats: [], // Structure: { id: string, title: string, messages: Array }
            currentChatId: null
        };

        let isStreaming = false;

        // --- TOAST NOTIFICATION SYSTEM ---
        /**
         * Displays a premium toast notification
         * @param {string} message - The text to display
         * @param {'error' | 'success' | 'info'} type - Type of toast
         */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            // Define colors based on type
            const colors = {
                error: 'bg-red-500 text-white border-red-600',
                success: 'bg-emerald-500 text-white border-emerald-600',
                info: 'bg-gray-800 text-white border-gray-900 dark:bg-gray-200 dark:text-gray-900'
            };

            const icons = {
                error: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
                success: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                info: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };

            toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border animate-slide-down pointer-events-auto ${colors[type]}`;
            toast.innerHTML = `
                <div class="shrink-0">${icons[type]}</div>
                <div class="text-sm font-medium flex-1">${escapeHTML(message)}</div>
                <button onclick="this.parentElement.remove()" class="shrink-0 p-1 opacity-70 hover:opacity-100 transition-opacity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;

            container.appendChild(toast);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-10px)';
                    toast.style.transition = 'all 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }

        // --- STORAGE & UTILS ---
        function generateId() {
            return 'chat_' + Math.random().toString(36).substring(2, 15);
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    state = { ...state, ...JSON.parse(saved) };
                }
                
                // Initialization fallback
                if (!state.chats || state.chats.length === 0) {
                    state.chats = [];
                    createNewChat(false);
                }
                
                if (!state.currentChatId || !state.chats.find(c => c.id === state.currentChatId)) {
                    state.currentChatId = state.chats[0]?.id;
                }

                applyTheme(state.darkMode);
            } catch (e) {
                console.error("State load failed:", e);
                showToast("Failed to load previous data. Starting fresh.", "error");
            }
        }

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("State save failed:", e);
                showToast("Local storage full or disabled.", "error");
            }
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
            }[tag] || tag));
        }

        // --- UI RENDERING ---
        function renderChatsList() {
            const listEl = document.getElementById('chat-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            const sortedChats = [...state.chats].reverse(); // Newest first

            sortedChats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between px-3 py-2.5 rounded-xl cursor-pointer transition-all duration-200 ${isActive ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-bold shadow-sm border border-blue-100 dark:border-blue-800/50' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800/50 hover:text-gray-900 dark:hover:text-gray-200 border border-transparent'}`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 overflow-hidden" onclick="switchChat('${chat.id}')">
                        <svg class="w-4 h-4 shrink-0 ${isActive ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        <span class="truncate text-[13px] flex-1">${escapeHTML(chat.title || 'New Conversation')}</span>
                    </div>
                    <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); renameChat('${chat.id}')" class="p-1.5 text-gray-400 hover:text-blue-500 transition-colors rounded-md hover:bg-white dark:hover:bg-gray-700" title="Rename">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="p-1.5 text-gray-400 hover:text-red-500 transition-colors rounded-md hover:bg-white dark:hover:bg-gray-700" title="Delete">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');
            const welcomeScreen = document.getElementById('welcome-screen');
            const titleEl = document.getElementById('current-chat-title');
            
            if (!container || !welcomeScreen || !titleEl) return;

            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat) return;

            titleEl.textContent = chat.title || "New Interface";

            // Purge existing message nodes (keep welcome screen safe)
            Array.from(container.children).forEach(child => {
                if (child.id !== 'welcome-screen') child.remove();
            });

            if (chat.messages.length === 0) {
                welcomeScreen.classList.remove('hidden');
            } else {
                welcomeScreen.classList.add('hidden');
                chat.messages.forEach(msg => {
                    container.appendChild(createMessageElement(msg.role, msg.content));
                });
                scrollToBottom();
            }
        }

        function createMessageElement(role, content, isStreamingNow = false) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            div.className = `flex w-full mx-auto gap-4 ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            if (isUser) {
                div.innerHTML = `
                    <div class="bg-gray-100 dark:bg-gemini-darkUserBubble text-gray-800 dark:text-gray-100 px-6 py-3.5 rounded-[2rem] rounded-tr-sm max-w-[85%] whitespace-pre-wrap font-medium text-[15px] shadow-sm border border-gray-200/50 dark:border-gray-700/50 leading-relaxed">
                        ${escapeHTML(content)}
                    </div>
                `;
            } else {
                const parsedContent = DOMPurify.sanitize(marked.parse(content || ''));
                const streamClass = isStreamingNow ? 'typing-cursor' : '';
                div.innerHTML = `
                    <div class="flex gap-4 w-full max-w-4xl">
                        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 shrink-0 flex items-center justify-center mt-1 shadow-md text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <div class="flex-1 overflow-hidden min-w-0 pt-1.5">
                            <div class="markdown-body text-gray-800 dark:text-gray-200 text-[15px] ${streamClass}">${parsedContent}</div>
                        </div>
                    </div>
                `;
            }
            return div;
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            // Slight delay ensures DOM has updated before scroll calculation
            setTimeout(() => {
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            }, 10);
        }

        // --- ACTIONS & EVENTS ---
        function createNewChat(render = true) {
            if (isStreaming) {
                showToast("Please wait for the AI to finish typing.", "info");
                return;
            }
            const newChat = { id: generateId(), title: "New Conversation", messages: [] };
            state.chats.push(newChat);
            state.currentChatId = newChat.id;
            saveState();
            
            if (render) {
                renderChatsList();
                renderMessages();
                if (window.innerWidth < 768) toggleSidebar(false);
            }
        }

        function switchChat(id) {
            if (isStreaming || state.currentChatId === id) return;
            state.currentChatId = id;
            saveState();
            renderChatsList();
            renderMessages();
            if (window.innerWidth < 768) toggleSidebar(false);
        }

        function deleteChat(id) {
            if (isStreaming) return;
            // Native confirm is okay here for immediate blocking action
            if (confirm("Permanently delete this conversation?")) {
                state.chats = state.chats.filter(c => c.id !== id);
                if (state.chats.length === 0) createNewChat(false);
                else if (state.currentChatId === id) state.currentChatId = state.chats[state.chats.length - 1].id;
                
                saveState();
                renderChatsList();
                renderMessages();
                showToast("Conversation deleted.", "success");
            }
        }

        function renameChat(id) {
            if (isStreaming) return;
            const chat = state.chats.find(c => c.id === id);
            if (!chat) return;
            const newTitle = prompt("Rename conversation:", chat.title);
            if (newTitle !== null && newTitle.trim() !== "") {
                chat.title = newTitle.trim();
                saveState();
                renderChatsList();
                if (state.currentChatId === id) renderMessages();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight < 200 ? textarea.scrollHeight : 200) + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- CORE API LOGIC ---
        async function sendMessage() {
            if (isStreaming) return;
            
            const inputEl = document.getElementById('message-input');
            const text = inputEl.value.trim();
            
            if (!text) return;

            if (!state.apiKey) {
                showToast("API Key Required. Please configure settings.", "error");
                openSettings();
                return;
            }

            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat) return;

            // Auto-title generation based on first prompt
            if (chat.messages.length === 0) {
                chat.title = text.length > 25 ? text.substring(0, 25) + '...' : text;
                renderChatsList();
            }

            // 1. Render User Message immediately
            chat.messages.push({ role: 'user', content: text });
            inputEl.value = '';
            inputEl.style.height = 'auto'; 
            saveState();
            renderMessages();

            // 2. Setup AI Message Shell
            isStreaming = true;
            document.getElementById('send-btn').disabled = true;
            
            const aiMessageObj = { role: 'assistant', content: '' };
            chat.messages.push(aiMessageObj);
            
            const container = document.getElementById('messages-container');
            const aiDomElement = createMessageElement('assistant', '', true);
            container.appendChild(aiDomElement);
            scrollToBottom();

            const markdownContainer = aiDomElement.querySelector('.markdown-body');

            // 3. Stream Engine Execution
            try {
                await streamOpenRouterAPI(
                    chat.messages.slice(0, -1), // Everything except the empty AI shell
                    (chunk) => {
                        aiMessageObj.content += chunk;
                        markdownContainer.innerHTML = DOMPurify.sanitize(marked.parse(aiMessageObj.content));
                        scrollToBottom();
                    }
                );
            } catch (error) {
                console.error("Stream Error:", error);
                const errorStr = `\n\n> **System Error:** ${error.message}`;
                aiMessageObj.content += errorStr;
                markdownContainer.innerHTML = DOMPurify.sanitize(marked.parse(aiMessageObj.content));
                showToast("Engine encountered an error.", "error");
            } finally {
                // 4. Cleanup and Unlock
                isStreaming = false;
                document.getElementById('send-btn').disabled = false;
                markdownContainer.classList.remove('typing-cursor');
                saveState();
            }
        }

        /**
         * Robust Streaming Fetch for OpenRouter
         */
        async function streamOpenRouterAPI(history, onChunk) {
            const apiMessages = [];
            if (state.systemPrompt && state.systemPrompt.trim() !== "") {
                apiMessages.push({ role: 'system', content: state.systemPrompt.trim() });
            }
            apiMessages.push(...history.map(m => ({ role: m.role, content: m.content })));

            const payload = {
                model: state.model || DEFAULT_MODEL,
                messages: apiMessages,
                stream: true
            };

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Studio Code Engine'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                let errMsg = `HTTP Error ${response.status}: ${response.statusText}`;
                try {
                    const parsedErr = JSON.parse(errorText);
                    errMsg = parsedErr.error?.message || errMsg;
                } catch(e) {}
                throw new Error(errMsg);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split("\n");
                
                // Retain incomplete chunks in buffer
                buffer = lines.pop(); 

                for (let line of lines) {
                    line = line.trim();
                    if (!line.startsWith("data: ")) continue;
                    
                    const dataStr = line.slice(6);
                    if (dataStr === "[DONE]") return;

                    try {
                        const parsed = JSON.parse(dataStr);
                        const content = parsed.choices?.[0]?.delta?.content;
                        if (content) onChunk(content);
                    } catch (e) {
                        // Silently ignore incomplete JSON chunks - they will resolve in next iteration
                    }
                }
            }
        }

        // --- LAYOUT & THEME CONTROLS ---
        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            const newState = forceState !== undefined ? forceState : !isOpen;

            if (newState) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function toggleTheme() {
            state.darkMode = !state.darkMode;
            applyTheme(state.darkMode);
            saveState();
        }

        function applyTheme(isDark) {
            const html = document.documentElement;
            const moon = document.getElementById('theme-icon-moon');
            const sun = document.getElementById('theme-icon-sun');
            
            if (isDark) {
                html.classList.add('dark');
                if(moon && sun) { moon.classList.add('hidden'); sun.classList.remove('hidden'); }
            } else {
                html.classList.remove('dark');
                if(moon && sun) { moon.classList.remove('hidden'); sun.classList.add('hidden'); }
            }
            
            // Update meta theme-color for mobile browsers
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if(!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }
            metaTheme.content = isDark ? '#131314' : '#ffffff';
        }

        // --- SETTINGS MODAL CONTROLS ---
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey || '';
            document.getElementById('model-input').value = state.model || DEFAULT_MODEL;
            document.getElementById('system-prompt-input').value = state.systemPrompt || '';
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-input').value.trim();
            const prompt = document.getElementById('system-prompt-input').value.trim();
            
            state.apiKey = apiKey;
            state.model = model || DEFAULT_MODEL;
            state.systemPrompt = prompt;
            
            saveState();
            closeSettings();
            showToast("Engine configuration saved.", "success");
        }

        // --- BOOTSTRAP / INITIALIZATION ---
        function initApp() {
            try {
                // Configure Marked.js safely for the latest version
                // This resolves the crash from the previous deprecated .setOptions()
                marked.use({
                    breaks: true,
                    gfm: true
                });

                // Hydrate State
                loadState();
                
                // Mount UI
                renderChatsList();
                renderMessages();

                // Artificial delay to show off the premium loader
                setTimeout(() => {
                    const loader = document.getElementById('loading');
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.6s ease';
                    
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                    }, 600);
                }, 1200);

            } catch (error) {
                console.error("Critical Engine Failure:", error);
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-500 flex flex-col items-center bg-white dark:bg-gray-900 p-8 rounded-2xl shadow-xl max-w-sm text-center border border-red-200 dark:border-red-900/50">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <p class="font-bold text-lg text-gray-900 dark:text-white mb-2">System Failure</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">${error.message}</p>
                        <button onclick="localStorage.clear(); location.reload();" class="px-6 py-2.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition-colors shadow-sm">Factory Reset</button>
                    </div>
                `;
            }
        }

        // Ignite Engine safely when DOM is ready
        window.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
