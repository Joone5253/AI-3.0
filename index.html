<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Studio Ultimate Pro | Joone Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        studio: {
                            50: '#f0f7ff', 100: '#e0effe', 200: '#bae0fd', 300: '#7cc7fb',
                            400: '#38a9f8', 500: '#0e8ce9', 600: '#026ec7', 700: '#0358a1',
                            800: '#074a85', 900: '#0c3f6e', 950: '#082849',
                        },
                        gray: { 950: '#030712' }
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '2.5rem' },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            height: 100vh;
            background: #ffffff;
        }
        .dark body { background: #030712; }

        /* Advanced Prose (Markdown) Styling */
        .prose { max-width: 100%; font-size: 1rem; line-height: 1.75; color: inherit; }
        .prose h1, .prose h2, .prose h3 { font-weight: 800; margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .prose p { margin-bottom: 1.25rem; }
        .prose pre { 
            background: #0d1117 !important; 
            padding: 1.5rem; 
            border-radius: 1.25rem; 
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            margin: 1.5rem 0;
        }
        .prose code { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 0.9em; 
            background: rgba(14, 140, 233, 0.1); 
            padding: 0.2rem 0.4rem; 
            border-radius: 0.5rem;
            color: #0e8ce9;
        }
        .dark .prose code { color: #7cc7fb; }
        .prose img { border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }

        /* Scrollbar Beauty */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; border: 2px solid transparent; background-clip: content-box; }

        /* Custom UI Components */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-container { height: calc(100vh - 180px); }
        
        #loading-overlay {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:hover { transform: translateY(-2px); }
        .btn-hover:active { transform: translateY(0); scale: 0.95; }

        /* Code Block Copy Button */
        .copy-code-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 0.5rem;
            color: #9ca3af;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .copy-code-btn:hover { background: rgba(255,255,255,0.1); color: white; }
    </style>
</head>
<body class="dark:text-gray-100">

    <div id="loading-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white dark:bg-gray-950">
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-4 border-studio-100 dark:border-studio-900 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-studio-500 rounded-full border-t-transparent animate-spin"></div>
            <div class="absolute inset-4 bg-studio-500/10 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-studio-500 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
        </div>
        <h2 class="text-xl font-extrabold tracking-tighter text-gray-900 dark:text-white uppercase">Studio Core Engine</h2>
        <p id="loading-text" class="mt-2 text-sm text-gray-400 font-medium">Calibrating neural links...</p>
    </div>

    <div id="studio-app" class="flex h-screen opacity-0 transition-opacity duration-700">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 glass-panel border-r border-gray-200 dark:border-gray-800 flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-500 ease-in-out">
            <div class="p-8">
                <div class="flex items-center gap-4 mb-10">
                    <div class="w-12 h-12 bg-gradient-to-tr from-studio-600 to-studio-400 rounded-2xl flex items-center justify-center text-white shadow-2xl shadow-studio-500/30">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-black text-xl leading-none">Joone Studio</h1>
                        <span class="text-[10px] font-bold text-studio-500 uppercase tracking-widest">Enterprise v4.0</span>
                    </div>
                </div>

                <button onclick="createNewSession()" class="w-full btn-hover flex items-center justify-center gap-3 py-4 px-6 bg-gray-900 dark:bg-studio-600 text-white rounded-2xl font-bold text-sm shadow-xl shadow-studio-500/10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"/></svg>
                    New Workspace
                </button>
            </div>

            <div id="session-history" class="flex-1 overflow-y-auto px-4 space-y-2 pb-10">
                </div>

            <div class="p-6 border-t border-gray-100 dark:border-gray-800">
                <div class="flex items-center justify-between mb-6 px-2">
                    <button onclick="toggleDarkMode()" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-2xl hover:bg-studio-50 dark:hover:bg-studio-900/30 transition-colors">
                        <svg id="theme-icon" class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 118.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                    <button onclick="toggleSettings()" class="p-3 bg-gray-100 dark:bg-gray-800 rounded-2xl hover:bg-studio-50 dark:hover:bg-studio-900/30 transition-colors">
                        <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-3 p-1">
                    <img src="https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Joone" class="w-10 h-10 rounded-xl bg-studio-100 dark:bg-studio-900" alt="Joone">
                    <div class="overflow-hidden">
                        <p class="font-bold text-sm truncate">Joone AI Administrator</p>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">Active Connection</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-gray-950 lg:ml-0 h-screen relative">
            
            <header class="h-20 flex items-center justify-between px-8 glass-panel sticky top-0 z-40">
                <div class="flex items-center gap-6">
                    <button onclick="toggleSidebarMenu()" class="lg:hidden p-3 -ml-2 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                    
                    <div id="active-mode-tag" class="flex items-center gap-3 px-5 py-2 bg-studio-50 dark:bg-studio-900/20 text-studio-600 dark:text-studio-400 rounded-2xl border border-studio-100 dark:border-studio-800/50">
                        <div class="relative flex h-2.5 w-2.5">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-studio-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-studio-600"></span>
                        </div>
                        <span id="current-model-text" class="text-xs font-black uppercase tracking-[0.15em]">Neural Link: Stable</span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button onclick="clearCurrentSession()" class="p-3 text-gray-400 hover:text-red-500 transition-colors" title="Clear History">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                    <button onclick="exportToMarkdown()" class="p-3 text-gray-400 hover:text-studio-500 transition-colors" title="Download Markdown">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    </button>
                </div>
            </header>

            <div id="chat-viewport" class="chat-container flex-1 overflow-y-auto px-6 py-10 md:px-20 space-y-12">
                <div id="empty-state" class="flex flex-col items-center justify-center h-full text-center space-y-6 animate-float">
                    <div class="w-24 h-24 bg-studio-500/5 rounded-[2.5rem] flex items-center justify-center">
                        <svg class="w-12 h-12 text-studio-500/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-3xl font-black tracking-tight mb-2">Workspace Ready</h3>
                        <p class="text-gray-400 text-sm font-medium max-w-sm mx-auto leading-relaxed">System initialized for multi-modal reasoning. Use the toggles below to switch between text, art, and video engines.</p>
                    </div>
                </div>
            </div>

            <div class="p-6 md:p-10 bg-gradient-to-t from-white via-white to-transparent dark:from-gray-950 dark:via-gray-950">
                <div class="max-w-4xl mx-auto">
                    
                    <div id="media-queue" class="hidden flex flex-wrap gap-3 mb-4 p-4 glass-panel rounded-3xl border border-studio-200 dark:border-studio-800 animate-slide-up"></div>

                    <div class="relative flex flex-col bg-gray-50 dark:bg-gray-900/50 rounded-[2.5rem] border-2 border-transparent focus-within:border-studio-500/30 focus-within:bg-white dark:focus-within:bg-gray-900 transition-all p-3 shadow-2xl">
                        
                        <textarea id="studio-input" rows="1" placeholder="Describe your request..." class="w-full bg-transparent px-6 py-4 outline-none resize-none text-gray-800 dark:text-gray-100 placeholder-gray-500 min-h-[56px] max-h-60 font-medium text-lg leading-relaxed"></textarea>
                        
                        <div class="flex items-center justify-between px-3 pb-2 pt-2">
                            <div class="flex items-center gap-2">
                                <input type="file" id="file-system" class="hidden" multiple onchange="processFiles(this)">
                                <button onclick="document.getElementById('file-system').click()" class="p-3.5 text-gray-500 hover:text-studio-500 hover:bg-white dark:hover:bg-gray-800 rounded-2xl transition-all" title="Add Assets">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                                </button>
                                
                                <button onclick="setEngineMode('art')" id="btn-art" class="p-3.5 text-gray-500 hover:text-purple-500 hover:bg-white dark:hover:bg-gray-800 rounded-2xl transition-all" title="Nano Banana Art">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                </button>

                                <button onclick="setEngineMode('video')" id="btn-video" class="p-3.5 text-gray-500 hover:text-orange-500 hover:bg-white dark:hover:bg-gray-800 rounded-2xl transition-all" title="Veo Cinema">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                </button>
                            </div>

                            <button id="execute-btn" onclick="handleExecution()" class="bg-studio-600 hover:bg-studio-700 text-white p-4 rounded-[1.5rem] shadow-2xl shadow-studio-600/30 active:scale-90 transition-all">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-panel" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 glass-panel !bg-black/60 backdrop-blur-xl">
        <div class="bg-white dark:bg-gray-900 w-full max-w-xl rounded-[3rem] p-12 shadow-3xl border border-gray-100 dark:border-gray-800">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-3xl font-black tracking-tight">Studio Config</h2>
                <button onclick="toggleSettings()" class="p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <div class="space-y-8">
                <div>
                    <label class="block text-[10px] font-black text-studio-500 mb-3 uppercase tracking-[0.25em]">OpenRouter Master Key</label>
                    <input type="password" id="api-key-store" placeholder="sk-or-v1-..." class="w-full p-5 bg-gray-50 dark:bg-gray-800 rounded-3xl border-2 border-transparent focus:border-studio-500 outline-none transition-all font-mono text-sm shadow-inner">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest">Logic Engine</label>
                        <input type="text" id="model-text-store" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl outline-none border border-transparent focus:border-studio-300 transition-all text-xs font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest">Visual Engine</label>
                        <input type="text" id="model-art-store" class="w-full p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl outline-none border border-transparent focus:border-purple-300 transition-all text-xs font-bold">
                    </div>
                </div>
                
                <div class="p-6 bg-studio-500/5 rounded-3xl border border-studio-500/10">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-studio-500 flex items-center justify-center text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <p class="text-[11px] font-semibold text-gray-500 leading-relaxed">Changes are stored locally in your browser. Sensitive keys are never transmitted outside of direct OpenRouter API calls.</p>
                    </div>
                </div>
            </div>

            <button onclick="saveStudioConfig()" class="w-full mt-10 py-5 bg-studio-600 hover:bg-studio-700 text-white font-black rounded-[2rem] transition-all shadow-2xl shadow-studio-600/30 uppercase tracking-[0.2em] text-xs">
                Synchronize Configuration
            </button>
        </div>
    </div>

    <script>
        // --- DATA ARCHITECTURE ---
        const StudioStore = {
            db: JSON.parse(localStorage.getItem('joone_studio_pro_v5')) || {
                sessions: [],
                activeId: null,
                config: {
                    apiKey: '',
                    textModel: 'google/gemini-2.0-pro-exp-02-05:free',
                    artModel: 'google/nano-banana',
                    vidModel: 'google/veo',
                    isDark: true
                }
            },
            mode: 'logic', // logic, art, video
            busy: false
        };

        // --- ENGINE CONTROLLER ---
        function initStudio() {
            // Apply Theme
            if (StudioStore.db.config.isDark) {
                document.documentElement.classList.add('dark');
                updateThemeIcons('dark');
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcons('light');
            }
            
            // Session Management
            if (StudioStore.db.sessions.length === 0) createNewSession();
            if (!StudioStore.db.activeId) StudioStore.db.activeId = StudioStore.db.sessions[0].id;

            renderSidebar();
            renderChat();

            // Textarea Logic
            const input = document.getElementById('studio-input');
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleExecution();
                }
            });

            // Loading Transition
            const loadingTexts = ["Initializing Models...", "Securing Connection...", "Mounting Workspace...", "Link Established."];
            let i = 0;
            const timer = setInterval(() => {
                document.getElementById('loading-text').innerText = loadingTexts[i];
                i++;
                if(i === loadingTexts.length) {
                    clearInterval(timer);
                    document.getElementById('loading-overlay').style.opacity = '0';
                    document.getElementById('loading-overlay').style.visibility = 'hidden';
                    document.getElementById('studio-app').classList.remove('opacity-0');
                }
            }, 300);
        }

        function createNewSession() {
            const id = 'sess_' + Date.now();
            const newSess = {
                id: id,
                title: 'New Neural Branch',
                history: [],
                created: new Date().toISOString()
            };
            StudioStore.db.sessions.unshift(newSess);
            StudioStore.db.activeId = id;
            save();
            renderSidebar();
            renderChat();
        }

        function setEngineMode(m) {
            StudioStore.mode = (StudioStore.mode === m) ? 'logic' : m;
            const tag = document.getElementById('active-mode-tag');
            const modelLabel = document.getElementById('current-model-text');
            const input = document.getElementById('studio-input');

            const themes = {
                logic: { label: 'Logic Engine Active', css: 'bg-studio-50 text-studio-600 border-studio-100', dot: 'bg-studio-600', ph: 'Describe your request...' },
                art: { label: 'Visual Engine: Nano', css: 'bg-purple-50 text-purple-600 border-purple-100', dot: 'bg-purple-600', ph: 'Describe the art to generate...' },
                video: { label: 'Motion Engine: Veo', css: 'bg-orange-50 text-orange-600 border-orange-100', dot: 'bg-orange-600', ph: 'Describe the cinematic scene...' }
            };

            const active = themes[StudioStore.mode];
            tag.className = `flex items-center gap-3 px-5 py-2 rounded-2xl border transition-all ${active.css}`;
            tag.querySelector('.relative span:last-child').className = `relative inline-flex rounded-full h-2.5 w-2.5 ${active.dot}`;
            modelLabel.innerText = active.label;
            input.placeholder = active.ph;
            input.focus();
        }

        async function handleExecution() {
            const input = document.getElementById('studio-input');
            const text = input.value.trim();
            if (!text || StudioStore.busy) return;

            if (!StudioStore.db.config.apiKey) {
                alert("Critical System Failure: API Key Missing.");
                toggleSettings();
                return;
            }

            const currentSess = StudioStore.db.sessions.find(s => s.id === StudioStore.db.activeId);
            
            // Add Message Chain
            currentSess.history.push({ role: 'user', content: text, mode: StudioStore.mode });
            const assistantEntry = { role: 'assistant', content: '', mode: StudioStore.mode };
            currentSess.history.push(assistantEntry);

            input.value = '';
            input.style.height = 'auto';
            StudioStore.busy = true;
            renderChat();

            try {
                const modelToUse = StudioStore.mode === 'art' ? StudioStore.db.config.artModel : 
                                  StudioStore.mode === 'video' ? StudioStore.db.config.vidModel : StudioStore.db.config.textModel;

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${StudioStore.db.config.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://joone.studio',
                        'X-Title': 'Joone AI Studio'
                    },
                    body: JSON.stringify({
                        model: modelToUse,
                        messages: currentSess.history.slice(0, -1).map(m => ({ role: m.role, content: m.content })),
                        stream: StudioStore.mode === 'logic'
                    })
                });

                if (StudioStore.mode === 'logic') {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const json = JSON.parse(line.substring(6));
                                    const delta = json.choices[0].delta.content || '';
                                    assistantEntry.content += delta;
                                    streamUpdateDOM(assistantEntry.content);
                                } catch (e) {}
                            }
                        }
                    }
                } else {
                    const data = await response.json();
                    let res = data.choices[0].message.content;
                    if (StudioStore.mode === 'art' && res.includes('http')) {
                        assistantEntry.content = `![Visual Output](${res})`;
                    } else {
                        assistantEntry.content = res;
                    }
                }

                // Title Generator
                if (currentSess.history.length === 2) {
                    currentSess.title = text.substring(0, 25) + '...';
                    renderSidebar();
                }

            } catch (err) {
                assistantEntry.content = "## ðŸ›‘ Neural Link Interrupted\nConnection to the AI backbone failed. Please check your network and API key.";
            } finally {
                StudioStore.busy = false;
                StudioStore.mode = 'logic';
                setEngineMode('logic');
                save();
                renderChat();
            }
        }

        // --- RENDER PIPELINE ---
        function renderChat() {
            const viewport = document.getElementById('chat-viewport');
            const session = StudioStore.db.sessions.find(s => s.id === StudioStore.db.activeId);
            
            if (!session.history.length) {
                document.getElementById('empty-state').classList.remove('hidden');
                viewport.innerHTML = '';
                viewport.appendChild(document.getElementById('empty-state'));
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            viewport.innerHTML = '';

            session.history.forEach(m => {
                const row = document.createElement('div');
                row.className = `flex w-full group ${m.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                if (m.role === 'user') {
                    bubble.className = "bg-studio-50 dark:bg-studio-900/30 border border-studio-100 dark:border-studio-800 px-7 py-5 rounded-[2.5rem] rounded-br-none max-w-[85%] text-base font-semibold shadow-sm";
                    bubble.innerText = m.content;
                } else {
                    bubble.className = "prose dark:prose-invert max-w-[90%] md:max-w-[85%] px-2";
                    bubble.innerHTML = marked.parse(m.content || '<div class="flex gap-2"><div class="w-2 h-2 bg-studio-500 rounded-full animate-bounce" style="animation-delay:0s"></div><div class="w-2 h-2 bg-studio-500 rounded-full animate-bounce" style="animation-delay:0.2s"></div><div class="w-2 h-2 bg-studio-500 rounded-full animate-bounce" style="animation-delay:0.4s"></div></div>');
                }
                
                row.appendChild(bubble);
                viewport.appendChild(row);
            });
            
            viewport.scrollTop = viewport.scrollHeight;
            hljs.highlightAll();
            addCodeCopyButtons();
        }

        function streamUpdateDOM(content) {
            const viewport = document.getElementById('chat-viewport');
            const bubbles = viewport.querySelectorAll('.prose');
            if (bubbles.length) {
                bubbles[bubbles.length - 1].innerHTML = marked.parse(content);
                viewport.scrollTop = viewport.scrollHeight;
            }
        }

        function renderSidebar() {
            const list = document.getElementById('session-history');
            list.innerHTML = '';
            StudioStore.db.sessions.forEach(s => {
                const active = s.id === StudioStore.db.activeId;
                const div = document.createElement('div');
                div.className = `p-4 rounded-[1.25rem] cursor-pointer transition-all flex items-center justify-between group ${active ? 'bg-studio-50 dark:bg-studio-900/40 text-studio-600 dark:text-studio-400 border border-studio-100 dark:border-studio-800' : 'hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-400'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-4 truncate" onclick="selectSession('${s.id}')">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <p class="text-xs font-black truncate tracking-tight uppercase">${s.title}</p>
                    </div>
                    <button onclick="deleteSession('${s.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 rounded-lg transition-all">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function addCodeCopyButtons() {
            document.querySelectorAll('pre').forEach(block => {
                if (block.querySelector('.copy-code-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'copy-code-btn';
                btn.innerText = 'Copy';
                btn.onclick = () => {
                    navigator.clipboard.writeText(block.innerText.replace('Copy', '').trim());
                    btn.innerText = 'Copied!';
                    setTimeout(() => btn.innerText = 'Copy', 2000);
                };
                block.appendChild(btn);
            });
        }

        // --- FILE HANDLING ---
        function processFiles(input) {
            const queue = document.getElementById('media-queue');
            queue.innerHTML = '';
            if (input.files.length) {
                queue.classList.remove('hidden');
                [...input.files].forEach(file => {
                    const tag = document.createElement('div');
                    tag.className = "flex items-center gap-3 px-4 py-2 bg-white dark:bg-gray-800 rounded-2xl text-[10px] font-black uppercase tracking-widest border border-studio-200 dark:border-studio-700 shadow-sm";
                    tag.innerHTML = `<span class="w-2 h-2 rounded-full bg-studio-500"></span> <span>${file.name}</span>`;
                    queue.appendChild(tag);
                });
            } else { queue.classList.add('hidden'); }
        }

        // --- UTILITIES ---
        function save() { localStorage.setItem('joone_studio_pro_v5', JSON.stringify(StudioStore.db)); }
        function selectSession(id) { StudioStore.db.activeId = id; save(); renderSidebar(); renderChat(); if(window.innerWidth < 1024) toggleSidebarMenu(); }
        function deleteSession(id) { StudioStore.db.sessions = StudioStore.db.sessions.filter(s => s.id !== id); if(StudioStore.db.activeId === id) StudioStore.db.activeId = StudioStore.db.sessions[0]?.id; if(!StudioStore.db.activeId) createNewSession(); save(); renderSidebar(); renderChat(); }
        function clearCurrentSession() { const s = StudioStore.db.sessions.find(s => s.id === StudioStore.db.activeId); s.history = []; s.title = "New Neural Branch"; save(); renderSidebar(); renderChat(); }
        function toggleDarkMode() { StudioStore.db.config.isDark = !StudioStore.db.config.isDark; document.documentElement.classList.toggle('dark'); updateThemeIcons(StudioStore.db.config.isDark ? 'dark' : 'light'); save(); }
        function updateThemeIcons(mode) {
            const icon = document.getElementById('theme-icon');
            if(mode === 'dark') icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/>';
            else icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 118.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
        }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); 
            document.getElementById('api-key-store').value = StudioStore.db.config.apiKey;
            document.getElementById('model-text-store').value = StudioStore.db.config.textModel;
            document.getElementById('model-art-store').value = StudioStore.db.config.artModel;
        }
        function saveStudioConfig() {
            StudioStore.db.config.apiKey = document.getElementById('api-key-store').value;
            StudioStore.db.config.textModel = document.getElementById('model-text-store').value;
            StudioStore.db.config.artModel = document.getElementById('model-art-store').value;
            save(); toggleSettings();
        }
        function toggleSidebarMenu() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function exportToMarkdown() {
            const session = StudioStore.db.sessions.find(s => s.id === StudioStore.db.activeId);
            let md = `# Studio Session: ${session.title}\n\n`;
            session.history.forEach(m => { md += `### ${m.role === 'user' ? 'Joone' : 'Studio'}\n${m.content}\n\n`; });
            const blob = new Blob([md], {type: 'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Studio-Export-${Date.now()}.md`; a.click();
        }

        window.onload = initStudio;
    </script>
</body>
</html>
